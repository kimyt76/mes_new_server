<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jct.mes_new.biz.order.mapper.ProgressMapper">

    <select id="getProgressList">
        select   a.contract_id
                ,b.item_cd
                ,(select item_name from tb_item_mst x where x.item_cd = b.item_cd) as item_name
                ,f.customer_name  as customerName
                ,a.contract_date+' -'+ CAST(a.seq AS NVARCHAR) as contractDate
                ,(select x.sale_date+' -'+ CAST(x.seq AS NVARCHAR) from tb_sale_mst x where x.sale_id = c.sale_id ) as saleDate
                ,(select x.shipment_date+' -'+ CAST(x.seq AS NVARCHAR) from tb_shipment_mst x where x.shipment_id = d.shipment_id ) as shipmentDate
                ,b.qty as totQty
                ,c.qty
                ,b.unit_price
                ,isnull(c.supply_price, b.supply_price) as supply_price
                ,isnull(c.vat_price, b.vat_price) as vat_price
                ,c.supply_price+c.vat_price as totPrice
                ,a.trading_Method
                ,e.member_nm as managerName
                ,a.customer_cd
                ,a.manager_id
        from   tb_contract_mst a
                inner join tb_contract_item b
                on a.contract_id = b.contract_id
                left outer join tb_sale_item c
                on b.contract_id = c.contract_id
                and b.item_cd = c.item_cd
                left outer join tb_shipment_item d
                on d.sale_id = c.sale_id
                and d.item_cd = c.item_cd
                inner join tb_users e
                on e.user_id = a.manager_id
                left outer join tb_customer f
                on f.customer_cd = a.customer_cd
        where   1=1
        <if test='itemName != "" and itemName != null'>
            AND b.item_name LIKE '%' + #{itemName} + '%'
        </if>
        <if test='managerName != "" and managerName != null'>
            AND e.member_nm LIKE '%' + #{managerName} + '%'
        </if>
        <if test='customerName != "" and customerName != null'>
            AND f.customer_name LIKE '%' + #{customerName} + '%'
        </if>
        order by b.item_cd desc, a.contract_date desc
    </select>



</mapper>